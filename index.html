<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIFAS LOMA - ¬°Gana $5,000! üçÄ</title>
    <style>
        :root { --primary: #1e40af; --gold: #fbbf24; --success: #22c55e; --danger: #ef4444; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f4f8; margin: 0; padding: 0; text-align: center; color: #1e293b; transition: padding-bottom 0.3s; }
        
        .header { background: linear-gradient(135deg, #0f172a 0%, #1e40af 100%); color: white; padding: 40px 15px; border-bottom: 5px solid var(--gold); }
        .header h1 { margin: 0; font-size: 35px; letter-spacing: 3px; text-shadow: 2px 2px #000; }
        
        .premio-grande { font-size: 50px; font-weight: 900; color: var(--gold); margin: 15px 0; text-shadow: 0 0 15px rgba(251, 191, 36, 0.6); display: inline-block; animation: pulse-suave 2s infinite ease-in-out; }
        @keyframes pulse-suave { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .container { max-width: 600px; margin: -20px auto 20px; background: white; padding: 25px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); position: relative; }
        
        .tools-section { background: #f8fafc; padding: 20px; border-radius: 20px; border: 1px solid #e2e8f0; margin-bottom: 25px; display: flex; flex-direction: column; gap: 15px; align-items: center; }
        
        .search-box { position: relative; width: 100%; max-width: 300px; }
        .search-box input { width: 100%; padding: 12px 15px 12px 40px; border-radius: 12px; border: 2px solid #cbd5e1; font-size: 16px; box-sizing: border-box; outline: none; }
        .search-icon { position: absolute; left: 14px; top: 12px; font-size: 18px; }

        .grid-numeros { display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 12px; max-height: 400px; overflow-y: auto; padding: 15px; background: #fff; border-radius: 15px; border: 1px solid #cbd5e1; scroll-behavior: smooth; }
        
        .boleto { padding: 15px 5px; background: white; border: 1px solid #cbd5e1; border-radius: 12px; cursor: pointer; transition: 0.2s; }
        .seleccionado { background: var(--primary) !important; color: white !important; }
        .vendido { background: #e2e8f0 !important; color: #94a3b8 !important; text-decoration: line-through; opacity: 0.5; cursor: help; }

        /* Estilos para el Buscador Din√°mico */
        .info-busqueda { margin-top: 10px; font-size: 14px; font-weight: bold; min-height: 20px; }

        .controles-flotantes { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 540px; display: none; flex-direction: column; gap: 10px; z-index: 999; }
        .btn-apartar-fijo { background: var(--success); color: white; border: none; padding: 18px; border-radius: 15px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 8px 20px rgba(34, 197, 94, 0.4); flex: 1; }
        .btn-limpiar-todo { background: var(--danger); color: white; border: none; padding: 10px; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 15% auto; padding: 25px; border-radius: 20px; width: 85%; max-width: 400px; text-align: center; }
        .tag-numero { display: inline-flex; align-items: center; background: #e0e7ff; color: #1e40af; padding: 5px 10px; border-radius: 8px; margin: 4px; font-weight: bold; }
        
        .footer { padding: 20px 20px 160px; font-size: 14px; color: #64748b; }
        .legal-notice { background: #f1f5f9; padding: 10px; border-radius: 10px; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div class="header">
    <h1>‚ú® RIFAS LOMA ‚ú®</h1>
    <div class="premio-grande">üí∞ $5,000 MXN üí∞</div><br>
    <div class="badge-precio" style="background:var(--success); color:white; padding:10px 25px; border-radius:50px; font-weight:bold; display:inline-block;">üçÄ ¬°Cada n√∫mero por solo $10! üçÄ</div>
</div>

<div class="container">
    <div class="tools-section">
        <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="number" id="buscador" placeholder="Busca un n√∫mero..." oninput="buscarNumeroAvanzado()">
        </div>
        <div id="resultadoBusqueda" class="info-busqueda"></div>

        <div style="font-weight: bold; color: var(--primary);">üé≤ ¬øCu√°ntos n√∫meros al azar?</div>
        <div class="azar-control">
            <input type="number" id="cantidadAzar" placeholder="Ej: 5" min="1">
            <button class="btn-azar-go" style="background:var(--primary); color:white; border:none; padding:10px; border-radius:10px; cursor:pointer" onclick="generarAzar()">¬°Probar suerte!</button>
        </div>
    </div>
    <div class="grid-numeros" id="tablero">Cargando...</div>
</div>

<div class="footer">
    üìç <b>Tonal√°, Jalisco.</b><br>
    Sorteo basado en la <b>Loter√≠a Nacional</b>.<br>
    <div class="legal-notice">‚öñÔ∏è Sorteo transparente y totalmente legal.</div>
</div>

<div id="controlesFlotantes" class="controles-flotantes">
    <button class="btn-limpiar-todo" onclick="limpiarTodo()">üóëÔ∏è Borrar selecci√≥n</button>
    <button class="btn-apartar-fijo" onclick="abrirModalFinal()">‚úÖ APARTAR (<span id="cantidadLabel">0</span>)</button>
</div>

<div id="modalFinal" class="modal">
    <div class="modal-content" style="text-align: left;">
        <h2>üìù Confirmar Apartado</h2>
        <div style="max-height: 150px; overflow-y: auto; background: #f8fafc; padding: 10px; border-radius: 10px; margin-bottom: 15px;" id="resumenFinal"></div>
        <input type="text" id="nombreCliente" placeholder="Nombre Completo" style="width:100%; padding:12px; margin:8px 0; border:1px solid #ddd; border-radius:10px; box-sizing:border-box;">
        <input type="tel" id="telCliente" placeholder="WhatsApp (10 d√≠gitos)" style="width:100%; padding:12px; margin:8px 0; border:1px solid #ddd; border-radius:10px; box-sizing:border-box;">
        <button style="background:var(--success); color:white; border:none; padding:15px; width:100%; border-radius:12px; font-size:18px; font-weight:bold; cursor:pointer;" onclick="finalizarCompra()">‚úÖ ENVIAR POR WHATSAPP</button>
        <button style="background:none; border:none; color:gray; width:100%; margin-top:10px; cursor:pointer" onclick="cerrarModalFinal()">Regresar</button>
    </div>
</div>

<script>
    const WHATSAPP_CEL = "523321550408";
    const URL_EXCEL_PAGADOS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTunKPG1TATOAhqerk253nBPufFK_qGmOqMc8bZpIkTJZcoKdZ66wwFByyWnQeo2ju4V9ECUv8aM2vi/pub?output=csv';

    let seleccionados = [];
    let baseDeDatos = {}; // Aqu√≠ guardaremos: { "123": { nombre: "Juan", status: "Pagado" } }

    async function cargarPagados() {
        try {
            const res = await fetch(URL_EXCEL_PAGADOS + '&t=' + Math.random());
            const csv = await res.text();
            const filas = csv.split(/\r?\n/).slice(1); // Ignoramos la primera fila (cabecera)
            
            filas.forEach(fila => {
                const columnas = fila.split(',');
                if(columnas[0]) {
                    const num = columnas[0].trim().padStart(3, '0');
                    baseDeDatos[num] = {
                        nombre: columnas[1] ? columnas[1].trim() : "Ocupado",
                        status: columnas[2] ? columnas[2].trim() : "Apartado"
                    };
                }
            });
            generarTablero();
        } catch (e) { generarTablero(); }
    }

    function generarTablero() {
        const tablero = document.getElementById('tablero');
        tablero.innerHTML = "";
        for (let i = 0; i <= 999; i++) {
            let n = i.toString().padStart(3, '0');
            let div = document.createElement('div');
            div.className = 'boleto';
            div.id = "b-" + n;
            div.innerHTML = `<span class="n-principal">${n}</span>`;
            
            if (baseDeDatos[n]) {
                div.classList.add('vendido');
                div.title = `De: ${baseDeDatos[n].nombre} (${baseDeDatos[n].status})`;
                div.onclick = () => alert(`N√∫mero ${n}\nDue√±o: ${baseDeDatos[n].nombre}\nEstado: ${baseDeDatos[n].status}`);
            } else {
                div.onclick = () => toggleSeleccion(n);
            }
            tablero.appendChild(div);
        }
    }

    function buscarNumeroAvanzado() {
        const val = document.getElementById('buscador').value;
        const resDiv = document.getElementById('resultadoBusqueda');
        if (!val) { resDiv.innerHTML = ""; return; }
        
        const n = val.padStart(3, '0');
        const elemento = document.getElementById("b-" + n);
        
        if (baseDeDatos[n]) {
            resDiv.style.color = "var(--danger)";
            resDiv.innerHTML = `‚ùå El ${n} ya es de: ${baseDeDatos[n].nombre} (${baseDeDatos[n].status})`;
        } else if (elemento) {
            resDiv.style.color = "var(--success)";
            resDiv.innerHTML = `‚úÖ El ${n} est√° disponible`;
            elemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
            elemento.style.border = "3px solid var(--gold)";
            setTimeout(() => elemento.style.border = "1px solid #cbd5e1", 2000);
        }
    }

    function toggleSeleccion(n) {
        if (seleccionados.includes(n)) {
            seleccionados = seleccionados.filter(item => item !== n);
            document.getElementById("b-" + n).classList.remove('seleccionado');
        } else {
            seleccionados.push(n);
            document.getElementById("b-" + n).classList.add('seleccionado');
        }
        actualizarUI();
    }

    function actualizarUI() {
        const cont = document.getElementById('controlesFlotantes');
        document.getElementById('cantidadLabel').innerText = seleccionados.length;
        cont.style.display = seleccionados.length > 0 ? 'flex' : 'none';
        document.body.style.paddingBottom = seleccionados.length > 0 ? "160px" : "0px";
    }

    function generarAzar() {
        const cant = parseInt(document.getElementById('cantidadAzar').value);
        if (isNaN(cant) || cant <= 0) return;
        let disponibles = [];
        for(let i=0; i<=999; i++) {
            let n = i.toString().padStart(3, '0');
            if(!baseDeDatos[n] && !seleccionados.includes(n)) disponibles.push(n);
        }
        for(let i=0; i<cant; i++) {
            if (disponibles.length === 0) break;
            let index = Math.floor(Math.random() * disponibles.length);
            let n = disponibles[index];
            seleccionados.push(n);
            document.getElementById("b-" + n).classList.add('seleccionado');
            disponibles.splice(index, 1);
        }
        actualizarUI();
        abrirModalFinal();
    }

    function limpiarTodo() {
        seleccionados.forEach(n => document.getElementById("b-" + n).classList.remove('seleccionado'));
        seleccionados = [];
        actualizarUI();
    }

    function renderResumen() {
        document.getElementById('resumenFinal').innerHTML = seleccionados.map(n => `
            <span class="tag-numero">${n}</span>
        `).join('');
    }

    function abrirModalFinal() { renderResumen(); document.getElementById('modalFinal').style.display = 'block'; }
    function cerrarModalFinal() { document.getElementById('modalFinal').style.display = 'none'; }

    function finalizarCompra() {
        const nombre = document.getElementById('nombreCliente').value;
        if(!nombre) { alert("Pon tu nombre"); return; }
        let total = seleccionados.length * 10;
        let mensaje = `*RIFAS LOMA üçÄ*%0A*CLIENTE:* ${nombre}%0A‚úÖ *MIS N√öMEROS:*%0A${seleccionados.join(', ')}%0Aüí∞ *TOTAL:* $${total} MXN%0A%0Aüè¶ *DATOS PAGO (BBVA):*%0AChristian Alejandro Reyna Huerta%0ACUENTA: 4152314129681402%0ACLABE: 012 180 01529748649 5`;
        window.open(`https://wa.me/${WHATSAPP_CEL}?text=${mensaje}`, '_blank');
        cerrarModalFinal();
    }

    cargarPagados();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIFAS LOMA - ¬°Gana $40,000! üçÄ</title>
    <style>
        :root { --primary: #1e40af; --gold: #fbbf24; --success: #22c55e; --bbva: #004481; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f4f8; margin: 0; padding: 0; text-align: center; color: #1e293b; }
        
        .header { background: linear-gradient(135deg, #0f172a 0%, #1e40af 100%); color: white; padding: 40px 15px; border-bottom: 5px solid var(--gold); }
        .header h1 { margin: 0; font-size: 35px; letter-spacing: 3px; text-shadow: 2px 2px #000; }
        .premio-grande { font-size: 50px; font-weight: 900; color: var(--gold); margin: 15px 0; text-shadow: 0 0 15px rgba(251, 191, 36, 0.6); }

        .container { max-width: 600px; margin: -20px auto 40px; background: white; padding: 25px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); position: relative; }
        
        .card-pago { background: #f8fafc; border: 2px dashed var(--bbva); border-radius: 15px; padding: 15px; margin-bottom: 20px; text-align: left; }
        .dato-bancario { font-family: monospace; font-size: 1.1em; font-weight: bold; color: #334155; display: block; margin: 5px 0; }

        /* SECCI√ìN ALEATORIA MEJORADA */
        .azar-box { background: #fffbeb; border: 2px solid var(--gold); padding: 15px; border-radius: 15px; margin-bottom: 20px; position: relative; }
        .azar-controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .azar-controls input { width: 80px; padding: 10px; border-radius: 10px; border: 1px solid var(--gold); text-align: center; font-size: 18px; }
        .btn-azar { background: var(--gold); color: #92400e; border: none; padding: 10px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        /* RECUADRO DE N√öMEROS ELEGIDOS (TICKET) */
        #ticketSuerte { 
            display: none; background: white; border: 2px solid var(--success); 
            border-radius: 15px; padding: 15px; margin-top: 15px;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.2);
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .numeros-lista { font-size: 24px; font-weight: 900; color: var(--success); letter-spacing: 2px; margin: 10px 0; }
        .btn-apartar-ya { background: var(--success); color: white; border: none; padding: 12px 25px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; }

        .grid-numeros { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); gap: 10px; 
            margin-top: 20px; max-height: 300px; overflow-y: auto; padding: 15px;
            background: #f8fafc; border-radius: 15px; border: 1px solid #cbd5e1;
        }
        .boleto { padding: 15px 0; background: white; border: 1px solid #cbd5e1; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .seleccionado { background: var(--primary) !important; color: white !important; }
        .vendido { background: #e2e8f0 !important; color: #94a3b8 !important; text-decoration: line-through; opacity: 0.5; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 5% auto; padding: 25px; border-radius: 20px; width: 85%; max-width: 400px; text-align: left; }
        .modal-content input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 10px; box-sizing: border-box; }

        .btn-confirmar { background: var(--success); color: white; border: none; padding: 15px; width: 100%; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn-apartar-fijo { 
            background: var(--success); color: white; border: none; padding: 22px; width: 90%; max-width: 540px;
            border-radius: 20px; font-size: 20px; font-weight: bold; cursor: pointer; 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            box-shadow: 0 10px 25px rgba(34, 197, 94, 0.5); z-index: 999; display: none;
        }
    </style>
</head>
<body>

<div class="header">
    <h1>‚ú® RIFAS LOMA ‚ú®</h1>
    <div class="premio-grande">üí∞ $40,000 MXN üí∞</div>
    <div class="badge-precio" style="background:var(--success); color:white; padding:10px 20px; border-radius:50px; font-weight:bold;">¬°Solo $40 pesitos! üçÄ</div>
</div>

<div class="container">
    <div class="card-pago">
        <p style="margin: 0; font-size: 14px; color: #64748b;">Cuenta a nombre de: <b>Christian Alejandro Reyna Huerta</b></p>
        <span class="dato-bancario">4152314129681402 (BBVA)</span>
    </div>

    <div class="azar-box">
        <h4>üé≤ ¬°N√∫meros al Azar!</h4>
        <div class="azar-controls">
            <input type="number" id="cantidadAzar" placeholder="Cant." min="1" max="20">
            <button class="btn-azar" onclick="seleccionarAzar()">GENERAR SUERTE</button>
        </div>

        <div id="ticketSuerte">
            <p style="margin:0; font-weight:bold; color:#1e293b;">Tus n√∫meros elegidos:</p>
            <div class="numeros-lista" id="listaElegidos">---</div>
            <button class="btn-apartar-ya" onclick="abrirModal()">‚úÖ APARTAR ESTOS N√öMEROS</button>
            <p style="font-size:11px; margin-top:8px; color:gray;">(Tambi√©n se marcaron en el tablero de abajo)</p>
        </div>
    </div>

    <div style="margin-bottom: 10px; font-size: 14px;">O busca uno manualmente:</div>
    <input type="number" id="buscar" placeholder="üîç Escribe tu n√∫mero..." oninput="filtrarNumeros()" style="width:90%; padding:12px; border-radius:10px; border:1px solid #ccc;">

    <div class="grid-numeros" id="tablero">
        <p>Cargando tablero...</p>
    </div>
</div>

<button id="btnFlotante" class="btn-apartar-fijo" onclick="abrirModal()">
    üé∞ APARTAR SELECCI√ìN (<span id="cantidad">0</span>)
</button>

<div id="miModal" class="modal">
    <div class="modal-content">
        <h2>üìù Finalizar Apartado</h2>
        <p style="font-size:14px;">N√∫meros: <b id="resumenNumeros"></b></p>
        <label>Nombre Completo:</label>
        <input type="text" id="nombreCliente" placeholder="Ej. Juan P√©rez">
        <label>Tu Tel√©fono:</label>
        <input type="tel" id="telCliente" placeholder="33 1234 5678">
        <button class="btn-confirmar" onclick="finalizarCompra()">‚úÖ ENVIAR POR WHATSAPP</button>
        <button style="background:none; border:none; color:gray; width:100%; margin-top:10px; cursor:pointer" onclick="cerrarModal()">Cancelar</button>
    </div>
</div>

<script>
    const WHATSAPP_CEL = "523321550408";
    const URL_EXCEL_PAGADOS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTunKPG1TATOAhqerk253nBPufFK_qGmOqMc8bZpIkTJZcoKdZ66wwFByyWnQeo2ju4V9ECUv8aM2vi/pub?output=csv';

    let seleccionados = [];
    let pagados = [];

    async function cargarPagados() {
        try {
            const res = await fetch(URL_EXCEL_PAGADOS + '&t=' + Math.random());
            const csv = await res.text();
            pagados = csv.split(/\r?\n/).map(linea => {
                let numero = linea.split(',')[0].trim();
                if (numero === "" || isNaN(numero)) return null;
                return numero.padStart(3, '0');
            }).filter(n => n !== null);
            generarTablero();
        } catch (e) { generarTablero(); }
    }

    function generarTablero() {
        const tablero = document.getElementById('tablero');
        tablero.innerHTML = "";
        for (let i = 0; i < 1000; i++) {
            let n = i.toString().padStart(3, '0');
            let div = document.createElement('div');
            div.className = 'boleto';
            div.id = "n-" + n;
            div.innerText = n;
            if (pagados.includes(n)) { div.classList.add('vendido'); } 
            else { div.onclick = () => seleccionar(n, div); }
            tablero.appendChild(div);
        }
    }

    function seleccionarAzar() {
        const cantInput = document.getElementById('cantidadAzar');
        const cantidad = parseInt(cantInput.value);
        if (isNaN(cantidad) || cantidad <= 0) { alert("¬øCu√°ntos boletos quieres?"); return; }

        // Limpiar selecci√≥n previa
        seleccionados.forEach(n => {
            const el = document.getElementById("n-" + n);
            if(el) el.classList.remove('seleccionado');
        });
        seleccionados = [];

        let disponibles = [];
        for (let i = 0; i < 1000; i++) {
            let n = i.toString().padStart(3, '0');
            if (!pagados.includes(n)) disponibles.push(n);
        }

        disponibles.sort(() => Math.random() - 0.5);
        const elegidos = disponibles.slice(0, Math.min(cantidad, disponibles.length));

        elegidos.forEach(n => {
            const el = document.getElementById("n-" + n);
            seleccionar(n, el);
        });

        // MOSTRAR EL TICKET CON LOS N√öMEROS
        document.getElementById('ticketSuerte').style.display = 'block';
        document.getElementById('listaElegidos').innerText = elegidos.join(' - ');
    }

    function seleccionar(num, elemento) {
        if (seleccionados.includes(num)) {
            seleccionados = seleccionados.filter(item => item !== num);
            if(elemento) elemento.classList.remove('seleccionado');
        } else {
            seleccionados.push(num);
            if(elemento) elemento.classList.add('seleccionado');
        }
        actualizarUI();
    }

    function actualizarUI() {
        const btn = document.getElementById('btnFlotante');
        btn.style.display = seleccionados.length > 0 ? 'block' : 'none';
        document.getElementById('cantidad').innerText = seleccionados.length;
        document.getElementById('resumenNumeros').innerText = seleccionados.join(', ');
        
        // Si borran todos manualmente, ocultar el ticket
        if(seleccionados.length === 0) document.getElementById('ticketSuerte').style.display = 'none';
    }

    function filtrarNumeros() {
        let val = document.getElementById('buscar').value;
        if(val.length > 0) {
            let n = val.padStart(3, '0').slice(-3);
            const el = document.getElementById("n-" + n);
            if(el) { 
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.border = "3px solid #fbbf24";
                setTimeout(() => el.style.border = "1px solid #cbd5e1", 2000);
            }
        }
    }

    function abrirModal() { document.getElementById('miModal').style.display = 'block'; }
    function cerrarModal() { document.getElementById('miModal').style.display = 'none'; }

    function finalizarCompra() {
        const nombre = document.getElementById('nombreCliente').value;
        const tel = document.getElementById('telCliente').value;
        if(!nombre || !tel) { alert("Por favor pon tu nombre y tel√©fono"); return; }
        
        let total = seleccionados.length * 40;
        let mensaje = `*RIFAS LOMA üçÄ*%0A*CLIENTE:* ${nombre}%0A*TEL:* ${tel}%0A%0A‚úÖ *N√öMEROS:* ${seleccionados.join(', ')}%0Aüí∞ *TOTAL:* $${total} MXN`;
        window.open(`https://wa.me/${WHATSAPP_CEL}?text=${mensaje}`, '_blank');
        cerrarModal();
    }

    cargarPagados();
</script>
</body>
</html>
